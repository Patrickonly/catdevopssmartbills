name: Code Review Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  automated-review:
    name: Automated Code Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit messages
        run: |
          echo "Checking commit message standards..."
          git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%s" | while read line; do
            if ! echo "$line" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{1,72}'; then
              echo "❌ Invalid commit message: $line"
              echo "Format should be: type(scope): description"
              echo "Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
              exit 1
            fi
          done
          echo "✅ All commit messages follow standards"

      - name: Check PR size
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          LINES_CHANGED=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | awk '{print $4+$6}')
          echo "Files changed: $FILES_CHANGED"
          echo "Lines changed: $LINES_CHANGED"
          
          if [ $FILES_CHANGED -gt 30 ]; then
            echo "⚠️ Warning: PR touches more than 30 files. Consider breaking it into smaller PRs."
          fi
          
          if [ $LINES_CHANGED -gt 500 ]; then
            echo "⚠️ Warning: PR changes more than 500 lines. Consider breaking it into smaller PRs."
          fi

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for unresolved TODO/FIXME comments..."
          if git diff origin/${{ github.base_ref }}...HEAD | grep -E '^\+.*TODO|FIXME'; then
            echo "⚠️ Warning: New TODO/FIXME comments found. Please resolve or create issues."
          else
            echo "✅ No new TODO/FIXME comments"
          fi

      - name: Lint JavaScript
        run: |
          npm install -g eslint
          npx eslint app.js --max-warnings 0 || true

      - name: Check code formatting
        run: |
          npm install -g prettier
          npx prettier --check "*.{js,html,css}" || true
