name: Monitoring & Feedback Loop

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:

jobs:
  check-health:
    name: Health Check
    runs-on: ubuntu-latest
    steps:
      - name: Check application health
        run: |
          HEALTH_URL="${{ secrets.APP_URL }}/health"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)
          
          if [ $RESPONSE -ne 200 ]; then
            echo "❌ Health check failed with status code: $RESPONSE"
            exit 1
          fi
          
          echo "✅ Health check passed"

      - name: Trigger deployment on failure
        if: failure()
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: health-check-failed
          client-payload: '{"status": "unhealthy", "timestamp": "${{ github.event.repository.updated_at }}"}'

  analyze-metrics:
    name: Analyze Metrics
    runs-on: ubuntu-latest
    steps:
      - name: Query Prometheus metrics
        run: |
          # Query error rate
          ERROR_RATE=$(curl -s "http://prometheus:9090/api/v1/query?query=rate(http_requests_total{status=~'5..'}[5m])" | jq -r '.data.result[0].value[1]')
          
          # Query response time
          RESPONSE_TIME=$(curl -s "http://prometheus:9090/api/v1/query?query=histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))" | jq -r '.data.result[0].value[1]')
          
          echo "Error Rate: $ERROR_RATE"
          echo "95th percentile Response Time: $RESPONSE_TIME"
          
          # Trigger scaling if needed
          if (( $(echo "$ERROR_RATE > 0.05" | bc -l) )); then
            echo "⚠️ High error rate detected, triggering scale up"
            curl -X POST ${{ secrets.WEBHOOK_URL }}/scale-up
          fi

  auto-remediation:
    name: Auto Remediation
    runs-on: ubuntu-latest
    if: github.event_name == 'repository_dispatch' && github.event.action == 'health-check-failed'
    steps:
      - name: Restart unhealthy pods
        run: |
          kubectl rollout restart deployment/smartbill-wasc -n smartbill-wasc
          
      - name: Notify team
        uses: 8398a7/action-slack@v3
        with:
          status: warning
          text: |
            ⚠️ Auto-remediation triggered
            Reason: Health check failed
            Action: Rolling restart initiated
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
